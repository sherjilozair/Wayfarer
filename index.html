<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!--Author: Sherjil Ozair -->
<!--Contact: sherjilozair@gmail.com -->
<!--Release: v0.1.3 (build no. 3)-->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
	<LINK REL=StyleSheet HREF="style.css" TYPE="text/css" MEDIA=screen>
    <script src="http://code.jquery.com/jquery-latest.js"></script>

    <title> WayFarer: Road Distances</title>
	<script>

        $(document).ready(function(){
            $('#textandbutton input').blur(function(){
                $('#textandbutton input').css({
                    opacity: 0.4,
                    'font-style': 'italic'
                });
            });
            $('#textandbutton input').focus(function(){
                $('#textandbutton input').css({
                    opacity: 0.8,
                    'font-style': 'normal'
                });
            });
        });


	    var inputs = new Array();
        var x = 0;
        
        function fare(){
            showMsg("Compiling...");
            var inp = document.getElementById('input').value;
            if (inp != ""){
                inputs[x++] = inp;
            }
            
            $("#textandbutton input").blur();
            
            
            var cities = inputs[0].replace(/,/g,"|").replace(/ /g, "+");
            
            for (i = 1; i < inputs.length; i++){
	            cities += "|" + inputs[i].replace(/,/g,"|").replace(/ /g, "+");
	        }
	        
	        var url = "http://maps.googleapis.com/maps/api/distancematrix/json?";
	        
	        url += "origins=" + cities + "&";
            url += "destinations=" + cities;
            url += "&mode=driving&language=en-EN&sensor=false";
            
            //alert(url);
            
            $.post("proxy.php", { url: url },
               function(data) {
                   //alert(data);
                   useJSON(JSON.parse(data));
               });
        }
        
        function useJSON(json){
            var errstr = error(json);
            if (errstr == "BIGERROR"){
                showMsg("Server Busy !");
            }
            else if(errstr == "BADINPUT"){
                inputs.splice(inputs.length - 1, 1);
                x--;
                showMsg("Bad Input !");
                
            }
            else if(errstr == "OK"){
                
                $('#output table').fadeOut( function(){
        	        $('#output table').html("");
    	            var html = "<tr><th>Distance</th>";
    	            var dest = json.destination_addresses;
    	            var origin = json.origin_addresses;
    	            
    	            //
    	            
    	            for (i = 0; i < dest.length; i++){
                        var names = dest[i].split(',');
                        
                        html += "<th>" + names[0];
                        html += "<div class='small'><p>";
                        if (names[1]){
                            html += names[1];
                        }
                        if(names[2]){
                            html += ", " + names[2];
                        }
                        html += "</p></div></th>"
                    }
                    html += "</tr>";
                    
                    var matrix = json.rows;
                    
                    for (i = 0; i < matrix.length; i++){
                        var names = origin[i].split(",");
                        html += "<tr><th>" + names[0];
                        html += "<div class='small'><p>";
                        if (names[1]){
                            html += names[1];
                        }
                        if(names[2]){
                            html += ", " + names[2];
                        }
                        html += "</p></div></th>"
                        for (j = 0; j < matrix[i].elements.length; j++){
                        if (matrix[i].elements[j].distance){
                            var val = matrix[i].elements[j].distance.text;
                        }
                        else{
                            var val = "-";
                        }
                        if(val == "1 m"){
                            val = "0";
                            }
                        if (i < j){
                            val = "";
                        }
                        
                        html += "<td>" + val + "</td>";
                        
                        }
                        html += "</tr>";
                    }
    	            $('#output table').html(html);
                    $('#output table').fadeIn();
    	        });
	        }
        }
        
        function error(json){
            if (json.status=="OK"){
                for (i = 0; i < json.rows.length; i++){
                    for (j = 0; j < json.rows[i].elements.length; j++){
                        if (json.rows[i].elements[j].status == "NOT_FOUND"){
                            return "BADINPUT";
                        }
                    }
                }
                return "OK";
            }
            else{
                return "BIGERROR";
            }
        }
        
        function showMsg(str){
            $('#message').fadeOut(400, function(){
                $('#message').html(str);
                $('#message').fadeIn(400, function(){
                    $('#message').fadeOut(400, function(){
                        $('#message').html("WayFarer");
                        $('#message').fadeIn(400);
                    });
                }).delay(1500);
            });
        }
	</script>
</head>

<body>
    <div id='textandbutton' class='input'>
        
            <div><label id='message' for='input'>
                    WayFarer
                </label>
            </div>
            <input id='input' 
                   name='input' 
                   type='text'
                   value='Enter cities...'
                   onfocus="{this.value='';}"
                   onblur="{this.value='Enter cities...'}" 
                   onkeypress='if (event.keyCode==13){fare();}'>
                   <p id='footer'>handcoded by sherjil ozair</p>
    </div>
    
    <div id='output'>
        <table id='table1'>
            
        </table>
    </div>
    
</body>
</html>
