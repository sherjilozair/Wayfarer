<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!--Author: Sherjil Ozair -->
<!--Contact: sherjilozair@gmail.com -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
	<LINK REL=StyleSheet HREF="style.css" TYPE="text/css" MEDIA=screen>
    <script src="http://code.jquery.com/jquery-latest.js"></script>
    <title> wayFarer: A distance chart generator utility </title>
	<script>
	    var cities = new Array();
	    var x = 0;
	    $(document).ready(function(){
            $('#message').fadeOut(0);
            // JQuery Setup code            
        });
        
	    function updatearr(){
	        var tmp = document.getElementById('cities').value;
	        //var cityarr = tmp.split(",");
	        //for (i = 0; i < cityarr.length; i++){
	            if (tmp != ""){
	                cities[x++] = tmp.replace(" ", "+");
	            }
            //}   
	        document.getElementById('cities').value = "";
	        
	    }
	    function queryG(){
	        var url = "http://maps.googleapis.com/maps/api/distancematrix/json?";	        
	        
	        var c = cities[0];
	        for (i = 1; i < cities.length; i++){
	            c += "|" + cities[i];
	        }
	        
            //c = c.replace(" ", "+");
            
            //alert( c );
            
            url += "origins=" + c + "&";
            url += "destinations=" + c;
            url += "&mode=driving";
            url += "&language=en-EN";
            url += "&sensor=false";
            //alert(url);
            $.post("proxy.php", { url: url },
               function(data) {
                   //alert(data);
                   
                   usedata(JSON.parse(data));
               });
	    }
	    function usedata(obj){
	        // Use it in the HTML
	    if (!check_status(obj)){
	        if (obj.status != "OK"){
	            // Big Error
	        }
	        else{
	            // Small Error (Move on)
	            cities.splice(cities.length - 1, 1);
	            x--;
	            $('#message').fadeIn(500, function(){
                    $('#message').fadeOut(1000);
                });
	        }
	    }
	    else{
	    $('#output table').fadeOut( function(){
	        $('#output table').html("");
	        
	    
	    
	        var destrow = '<tr><th>Distance</th>';
            for (i = 0; i < obj.destination_addresses.length; i++){
                destrow += "<th>" + obj.destination_addresses[i].split(",")[0];
                if(obj.destination_addresses[i].split(",")[1]){
                destrow += "<div class='small'> <p>" + obj.destination_addresses[i].split(",")[1] + "</p></div></th>";}
            }
            destrow += "</tr>";
            var html = "";
            html += destrow;
            for(i = 0; i < obj.rows.length; i++){
                html += "<tr>";
                html += "<th>" + obj.origin_addresses[i].split(",")[0];
                if(obj.origin_addresses[i].split(",")[1]){html +="<div class='small'><p>" + obj.origin_addresses[i].split(",")[1] + "</p></div></th>";}
                for (j = 0; j < obj.rows[i].elements.length; j++){
                    if (obj.rows[i].elements[j].distance.text != "1 m" && i > j){

                    html += "<td>" + obj.rows[i].elements[j].distance.text + "</td>";
                    }
                    else{
                        html += "<td> - </td>";
                    }
                }
                html += "</tr>";

            }
            $('#output table').html(html);
            // TODO position
            $('#output table').fadeIn();
	    });
	    }  
    }
    
    function check_status(obj){
        if (obj.status=="OK"){
            for (i = 0; i < obj.rows.length; i++){
                for (j = 0; j < obj.rows[i].elements.length; j++){
                    if (obj.rows[i].elements[j].status != "OK"){
                        return false;
                    }
                }
            }
            return true;
        }
        else{
            return false;
        }
    }
	</script>
</head>

<body>
    <div id='textandbutton' class='input'>
        
            <label for='cities'> Wayfarer: </label><input id='cities' name='cities' type='text' onkeypress='if (event.keyCode==13){updatearr(); queryG();}'><pre id='message'>  Bad Input !</pre>
    </div>
    <div id='output'>
        <table id='table1'>
            
        </table>
    </div>

</body>
</html>
